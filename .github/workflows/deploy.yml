name: Build & Deploy
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "☁️ checkout repository"
      uses: actions/checkout@v2

      - name: "🔧 setup node"
        uses: actions/setup-node@v2.1.5
        with:
          node-version: 18

      - name: "🔧 install pnpm"
        uses: pnpm/action-setup@v2

      - name: "🚀 static app"
        run: pnpm run build

    deploy:
      runs-on: ubuntu-latest
      needs: [build]
      steps:
        - name: Deploy App
          uses: appleboy/ssh-action@v0.1.7
          with:
            host: ${{secrets.MR_KRABS_HOST}}
            key: ${{secrets.MR_KRABS_KEY}}
            username: ${{secrets.MR_KRABS_USER}}

            script: |
              sudo apt-get install -y rsync
              rsync -azP ./public/ ${{secrets.MR_KRABS_USER}}@${{secrets.MR_KRABS_HOST}}:/home/projects/george-webapp/public
              echo "Deployment Successful"
